<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document to Vector Converter</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://api.fontshare.com/v2/css?f[]=satoshi@400,500,700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-page: #F9FAFB;
            --bg-card: #FFFFFF;
            --bg-surface: #F3F4F6;
            --bg-surface-hover: #E5E7EB;
            
            --text-primary: #1F2937;
            --text-secondary: #6B7281;
            
            --accent: #009F68;
            --accent-dark: #1D4ED8;
            
            --border-color: #D1D5DB;
            --shadow-color: rgba(99, 102, 241, 0.1);
            
            --error: #EF4444;
            --success: #22C55E;

            --font-body: 'Satoshi', sans-serif;
            --font-mono: 'JetBrains Mono', monospace;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-body);
            background-color: var(--bg-page);
            color: var(--text-primary);
            max-width: 900px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .container {
            display: flex;
            flex-direction: column;
            gap: 32px;
        }

        header {
            text-align: center;
        }
        
        header img {
            height: 36px;
            margin-bottom: 24px;
        }

        header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        header .subtitle {
            font-size: 1.1rem;
            color: var(--text-secondary);
            margin-top: 8px;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        .step-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 16px var(--shadow-color);
            transition: all 0.3s ease;
        }

        .step-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .step-number {
            background: var(--accent);
            color: white;
            font-weight: 700;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: grid;
            place-items: center;
            font-size: 0.9rem;
        }

        .step-header h2 {
            font-size: 1.5rem;
            font-weight: 600;
        }
        
        /* Step 1: API Key */
        .api-key-container {
            position: relative;
        }
        .api-key-container input {
            width: 100%;
            padding-right: 40px;
        }
        .api-key-container .fa-eye, .api-key-container .fa-eye-slash {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
            cursor: pointer;
        }
        
        /* Step 2: Upload */
        .upload-area {
            border: 2px dashed var(--border-color);
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            background-color: var(--bg-page);
        }
        .upload-area:hover, .upload-area.dragover {
            border-color: var(--accent);
            background-color: var(--bg-surface-hover);
        }
        .upload-area i {
            font-size: 2.5rem;
            color: var(--accent);
            margin-bottom: 16px;
        }
        input[type="file"] { display: none; }
        #fileList {
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-surface);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.9rem;
            animation: fadeIn 0.3s ease;
        }
        .file-item .fa-times {
            color: var(--error);
            cursor: pointer;
            margin-left: 12px;
        }

        /* Step 3: Config */
        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        .config-item label {
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--text-secondary);
        }
        .tooltip-icon {
            cursor: help;
            position: relative;
        }
        .tooltip-icon .tooltip-text {
            visibility: hidden;
            width: 220px;
            background-color: var(--text-primary);
            color: white;
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -110px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.85rem;
        }
        .tooltip-icon:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        /* General Controls */
        input[type="number"], input[type="text"], input[type="password"], select {
            width: 100%;
            background: var(--bg-surface);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 10px 12px;
            color: var(--text-primary);
            font-family: var(--font-body);
            font-size: 1rem;
        }
        input:focus, select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
        }

        /* Step 4: Actions */
        .action-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }
        button {
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-family: var(--font-body);
        }
        .primary-btn {
            color: white;
            background: var(--accent);
        }
        .primary-btn:hover { background: var(--accent-dark); }
        .primary-btn:disabled {
            background: var(--bg-surface-hover);
            color: var(--text-secondary);
            cursor: not-allowed;
        }
        .secondary-btn {
            background: var(--bg-surface);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }
        .secondary-btn:hover { background: var(--bg-surface-hover); }
        
        /* Progress & Stats */
        #progress { display: none; margin-top: 20px; }
        .progress-bar { width: 100%; height: 8px; background-color: var(--bg-surface); border-radius: 4px; overflow: hidden; margin: 8px 0; }
        #progressFill { height: 100%; width: 0%; background: var(--accent); transition: width 0.3s ease; }
        #progressDetails { font-size: 0.8rem; color: var(--text-secondary); }

        #stats { display: none; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 16px; margin-top: 20px; }
        .stat-item { text-align: center; padding: 16px; background-color: var(--bg-surface); border-radius: 8px; }
        .stat-value { font-size: 2rem; font-weight: 700; color: var(--accent); }
        .stat-label { font-size: 0.8rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; }

        /* Output */
        #outputSection { display: none; }
        .output-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .output-preview {
            background: var(--bg-page);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 16px;
            font-family: var(--font-mono);
            font-size: 0.85rem;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            color: var(--text-primary);
        }
        /* JSON Syntax Highlighting */
        .json-key { color: #9333ea; }    /* Purple */
        .json-string { color: #16a34a; } /* Green */
        .json-number { color: #ea580c; }  /* Orange */
        .json-boolean { color: #ca8a04; }/* Amber */
        .json-null { color: #6b7281; }   /* Gray */

        /* Messages */
        .message {
            padding: 12px 16px; border-radius: 8px; margin-bottom: 20px;
            font-weight: 500; text-align: center;
            animation: fadeInDown 0.5s ease;
            color: white;
        }
        .error { background: var(--error); }
        .success { background: var(--success); }
        .info { background: var(--accent); }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeInDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <img src="./delegasi-logo.png" alt="Delegasi Logo">
            <h1>Document to Vector Converter</h1>
            <p class="subtitle">A lightweight tool to instantly convert PDFs, TXT, and MD files into vector JSON for RAG applications.</p>
        </header>
        
        <div id="messageContainer"></div>

        <div class="step-card">
            <div class="step-header">
                <span class="step-number">1</span>
                <h2>Set Your API Key</h2>
            </div>
            <p style="color: var(--text-secondary); margin-bottom: 16px;">
                Your OpenAI API key is required to generate embeddings. It's only used in your browser and never sent to any server.
                <a href="https://platform.openai.com/api-keys" target="_blank" style="color: var(--accent); font-weight: 500;">Get your key here</a>.
            </p>
            <div class="api-key-container">
                <input type="password" id="apiKey" placeholder="sk-...">
                <i id="apiKeyToggle" class="fa-solid fa-eye"></i>
            </div>
        </div>

        <div class="step-card">
            <div class="step-header">
                <span class="step-number">2</span>
                <h2>Upload Your Documents</h2>
            </div>
            <div class="upload-area" id="uploadArea">
                <i class="fa-solid fa-file-arrow-up"></i>
                <h3>Drag & Drop Documents Here</h3>
                <p style="color: var(--text-secondary);">or <strong>click to browse</strong></p>
                <input type="file" id="fileInput" accept=".pdf, .txt, .md" multiple>
            </div>
            <div id="fileList"></div>
            
             <div class="sample-section" style="margin-top: 20px;">
                <p style="text-align:center; color: var(--text-secondary); margin-bottom: 12px;">— or try a sample document —</p>
                <div class="action-buttons" style="justify-content: center;">
                    <button class="secondary-btn" onclick="loadSampleDoc('manual')" style="padding: 8px 16px;">📖 Manual</button>
                    <button class="secondary-btn" onclick="loadSampleDoc('faq')" style="padding: 8px 16px;">❓ FAQ</button>
                    <button class="secondary-btn" onclick="loadSampleDoc('policy')" style="padding: 8px 16px;">📋 Policy</button>
                </div>
            </div>
        </div>
        
        <div class="step-card">
            <div class="step-header">
                <span class="step-number">3</span>
                <h2>Configure Splitting & Embedding</h2>
            </div>
            <div class="config-grid">
                <div class="config-item">
                    <label for="chunkSize">Chunk Size 
                        <span class="tooltip-icon"><i class="fa-solid fa-circle-question"></i>
                            <span class="tooltip-text">The max characters in each text chunk. Smaller chunks give more specific results but cost more. (Default: 1000)</span>
                        </span>
                    </label>
                    <input type="number" id="chunkSize" value="1000" min="100" max="5000">
                </div>
                <div class="config-item">
                    <label for="chunkOverlap">Chunk Overlap
                        <span class="tooltip-icon"><i class="fa-solid fa-circle-question"></i>
                            <span class="tooltip-text">How many characters to overlap between chunks. This helps keep context from being lost at the edges. (Default: 200)</span>
                        </span>
                    </label>
                    <input type="number" id="chunkOverlap" value="200" min="0" max="500">
                </div>
                <div class="config-item">
                    <label for="embeddingModel">Embedding Model</label>
                    <select id="embeddingModel">
                        <option value="text-embedding-3-small">text-embedding-3-small (Fast & Cheap)</option>
                        <option value="text-embedding-3-large">text-embedding-3-large (Best Quality)</option>
                        <option value="text-embedding-ada-002">text-embedding-ada-002 (Legacy)</option>
                    </select>
                </div>
                 <div class="config-item">
                    <label for="outputFilename">Output Filename</label>
                    <input type="text" id="outputFilename" value="rag-vectors.json">
                </div>
            </div>
        </div>

        <div class="step-card">
            <div class="step-header">
                <span class="step-number">4</span>
                <h2>Generate & Download</h2>
            </div>
            <div class="action-buttons">
                <button id="convertBtn" onclick="convertFiles()" class="primary-btn" disabled>
                    <i class="fa-solid fa-wand-magic-sparkles"></i> Convert to Vectors
                </button>
                <button onclick="clearAll()" class="secondary-btn">
                    <i class="fa-solid fa-trash"></i> Clear All
                </button>
            </div>
            <div class="progress" id="progress">
                <div id="progressText">Processing...</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div id="progressDetails"></div>
            </div>
        </div>
        
        <div class="step-card" id="resultsCard" style="display: none;">
             <div class="step-header">
                <span class="step-number" style="background: var(--success); color: white;"><i class="fa-solid fa-check"></i></span>
                <h2>Results</h2>
            </div>
            <div class="stats" id="stats">
                <div class="stat-item"><div class="stat-value" id="statFiles">0</div><div class="stat-label">Files</div></div>
                <div class="stat-item"><div class="stat-value" id="statPages">0</div><div class="stat-label">Pages</div></div>
                <div class="stat-item"><div class="stat-value" id="statChunks">0</div><div class="stat-label">Vectors</div></div>
                <div class="stat-item"><div class="stat-value" id="statSize">0 MB</div><div class="stat-label">Size</div></div>
            </div>
            <div class="output" id="outputSection" style="margin-top: 20px;">
                <div class="output-header">
                    <h3>📋 Generated JSON (Preview)</h3>
                    <div>
                         <button id="copyBtn" onclick="copyOutput()" class="secondary-btn" style="padding: 8px 12px; font-size: 0.9rem;">
                            <i class="fa-solid fa-copy"></i> Copy
                        </button>
                        <button id="downloadBtn" onclick="downloadJSON()" class="secondary-btn" style="padding: 8px 12px; font-size: 0.9rem;">
                           <i class="fa-solid fa-download"></i> Download
                        </button>
                    </div>
                </div>
                <div class="output-preview" id="outputPreview"></div>
            </div>
        </div>

    </div>

    <script>
        // --- JAVASCRIPT LOGIC (Unchanged) ---
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        
        let selectedFiles = []; 
        let processedVectors = [];
        window.vectorsOutput = null;

        const dom = {
            apiKey: document.getElementById('apiKey'),
            apiKeyToggle: document.getElementById('apiKeyToggle'),
            uploadArea: document.getElementById('uploadArea'),
            fileInput: document.getElementById('fileInput'),
            fileList: document.getElementById('fileList'),
            convertBtn: document.getElementById('convertBtn'),
            progress: document.getElementById('progress'),
            progressFill: document.getElementById('progressFill'),
            progressText: document.getElementById('progressText'),
            progressDetails: document.getElementById('progressDetails'),
            resultsCard: document.getElementById('resultsCard'),
            stats: document.getElementById('stats'),
            outputSection: document.getElementById('outputSection'),
            outputPreview: document.getElementById('outputPreview'),
            messageContainer: document.getElementById('messageContainer'),
        };

        document.addEventListener('DOMContentLoaded', validateInputs);
        dom.apiKey.addEventListener('input', validateInputs);
        dom.apiKeyToggle.addEventListener('click', toggleApiKeyVisibility);
        dom.uploadArea.addEventListener('click', () => dom.fileInput.click());
        dom.uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); dom.uploadArea.classList.add('dragover'); });
        dom.uploadArea.addEventListener('dragleave', (e) => { e.preventDefault(); dom.uploadArea.classList.remove('dragover'); });
        dom.uploadArea.addEventListener('drop', handleFileDrop);
        dom.fileInput.addEventListener('change', handleFileSelect);

        function handleFileDrop(e) {
            e.preventDefault();
            dom.uploadArea.classList.remove('dragover');
            addFiles(e.dataTransfer.files);
        }

        function handleFileSelect() {
            addFiles(dom.fileInput.files);
            dom.fileInput.value = ''; 
        }

        function addFiles(files) {
            const supportedFiles = Array.from(files).filter(file => {
                const extension = file.name.toLowerCase().split('.').pop();
                return ['pdf', 'txt', 'md'].includes(extension) || 
                       file.type === 'application/pdf' || 
                       file.type === 'text/plain' || 
                       file.type === 'text/markdown';
            });
            
            if (supportedFiles.length === 0) {
                showMessage('Please select PDF, TXT, or MD files only.', 'error');
                return;
            }

            supportedFiles.forEach(file => {
                if (!selectedFiles.some(f => f.file.name === file.name && f.file.size === file.size)) {
                    const extension = file.name.toLowerCase().split('.').pop();
                    let type = 'pdf';
                    if (['txt', 'md'].includes(extension)) {
                        type = extension;
                    }
                    selectedFiles.push({ id: `file-${Date.now()}-${Math.random()}`, file: file, type: type });
                }
            });
            renderFileList();
            validateInputs();
        }

        function removeFile(id) {
            selectedFiles = selectedFiles.filter(f => f.id !== id);
            renderFileList();
            validateInputs();
        }

        function renderFileList() {
            dom.fileList.innerHTML = '';
            if (selectedFiles.length === 0) return;

            const listTitle = document.createElement('h4');
            listTitle.textContent = 'Selected Files:';
            listTitle.style.color = 'var(--text-secondary)';
            listTitle.style.marginBottom = '8px';
            listTitle.style.fontWeight = '500';
            dom.fileList.appendChild(listTitle);

            selectedFiles.forEach(f => {
                const item = document.createElement('div');
                item.className = 'file-item';
                
                let iconClass = 'fa-file-alt';
                let iconColor = 'var(--accent)';
                
                if (f.type === 'pdf') {
                    iconClass = 'fa-file-pdf';
                    iconColor = '#dc2626';
                } else if (f.type === 'txt') {
                    iconClass = 'fa-file-lines';
                    iconColor = '#059669';
                } else if (f.type === 'md') {
                    iconClass = 'fa-file-code';
                    iconColor = '#7c3aed';
                }
                
                item.innerHTML = `
                    <span><i class="fa-solid ${iconClass}" style="margin-right: 8px; color: ${iconColor};"></i> ${f.file.name}</span>
                    <i class="fa-solid fa-times" onclick="removeFile('${f.id}')"></i>
                `;
                dom.fileList.appendChild(item);
            });
        }
        
        function validateInputs() {
            const hasFiles = selectedFiles.length > 0;
            const hasValidKey = dom.apiKey.value.trim().startsWith('sk-') && dom.apiKey.value.trim().length > 20;
            dom.convertBtn.disabled = !(hasFiles && hasValidKey);
        }
        
        function toggleApiKeyVisibility() {
            const isPassword = dom.apiKey.type === 'password';
            dom.apiKey.type = isPassword ? 'text' : 'password';
            dom.apiKeyToggle.className = `fa-solid ${isPassword ? 'fa-eye-slash' : 'fa-eye'}`;
        }
        
        async function convertFiles() {
            if (dom.convertBtn.disabled) return;
            
            dom.convertBtn.disabled = true;
            dom.progress.style.display = 'block';
            resetResults();

            let allDocs = [];
            let totalChunks = 0;

            try {
                showProgress(0, '🚀 Preparing files...', 'Reading selected documents.');
                for (const fileObj of selectedFiles) {
                    let doc;
                    if (fileObj.type === 'pdf') {
                        doc = await extractPDFText(fileObj.file);
                    } else if (fileObj.type === 'txt' || fileObj.type === 'md') {
                        doc = await extractTextFile(fileObj.file, fileObj.type);
                    } else { 
                        doc = createDocFromText(fileObj.file.name, fileObj.content);
                    }
                    allDocs.push(doc);
                    totalChunks += doc.chunks.length;
                }
                
                if (totalChunks === 0) {
                   throw new Error("No text could be extracted or chunked from the provided documents.");
                }

                processedVectors = [];
                let processedChunks = 0;
                
                for (const doc of allDocs) {
                    for (let i = 0; i < doc.chunks.length; i++) {
                        const chunk = doc.chunks[i];
                        const progress_pct = 10 + ((processedChunks / totalChunks) * 80);
                        
                        showProgress(
                            progress_pct, 
                            `✨ Vectorizing... (${processedChunks + 1}/${totalChunks})`,
                            `Embedding chunk from: ${doc.title}`
                        );
                        
                        try {
                            const embedding = await createEmbedding(chunk);
                            processedVectors.push({
                                id: `${doc.title.replace(/[^a-zA-Z0-9]/g, '_')}_chunk_${i}`,
                                text: chunk,
                                embedding: embedding,
                                metadata: { source: doc.filename, title: doc.title }
                            });
                        } catch (error) {
                            console.error(`Skipping chunk due to error:`, error);
                            showMessage(`Warning: Failed to process a chunk from ${doc.title}. Check console for details.`, 'error');
                        }
                        
                        processedChunks++;
                        await new Promise(resolve => setTimeout(resolve, 50));
                    }
                }

                showProgress(95, 'Finalizing...', 'Almost there!');
                window.vectorsOutput = {
                    metadata: {
                        createdAt: new Date().toISOString(),
                        totalVectors: processedVectors.length,
                        embeddingModel: document.getElementById('embeddingModel').value,
                        chunkSize: parseInt(document.getElementById('chunkSize').value),
                        chunkOverlap: parseInt(document.getElementById('chunkOverlap').value),
                    },
                    vectors: processedVectors
                };

                showProgress(100, '✅ Complete!', 'Your vectors are ready.');
                displayResults(allDocs);
                showMessage(`Successfully generated ${processedVectors.length} vectors!`, 'success');

            } catch (error) {
                console.error('Conversion error:', error);
                showMessage(`Error: ${error.message}`, 'error');
                dom.progress.style.display = 'none';
            } finally {
                dom.convertBtn.disabled = false;
            }
        }
        
        async function extractPDFText(file) {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
            
            let fullText = '';
            for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                const page = await pdf.getPage(pageNum);
                const content = await page.getTextContent();
                const pageText = content.items.map(item => item.str).join(' ').replace(/\s+/g, ' ').trim();
                fullText += pageText + '\n\n';
            }
            
            const chunkSize = parseInt(document.getElementById('chunkSize').value);
            const chunkOverlap = parseInt(document.getElementById('chunkOverlap').value);
            const chunks = chunkText(fullText.trim(), chunkSize, chunkOverlap);
            
            return {
                filename: file.name,
                title: file.name.replace('.pdf', ''),
                pages: pdf.numPages,
                chunks: chunks,
                size: file.size,
            };
        }
        
        async function extractTextFile(file, fileType) {
            const text = await file.text();
            const chunkSize = parseInt(document.getElementById('chunkSize').value);
            const chunkOverlap = parseInt(document.getElementById('chunkOverlap').value);
            const chunks = chunkText(text.trim(), chunkSize, chunkOverlap);
            
            return {
                filename: file.name,
                title: file.name.replace(`.${fileType}`, ''),
                pages: 1,
                chunks: chunks,
                size: file.size,
            };
        }
        
        function createDocFromText(filename, content) {
            const chunkSize = parseInt(document.getElementById('chunkSize').value);
            const chunkOverlap = parseInt(document.getElementById('chunkOverlap').value);
            const chunks = chunkText(content, chunkSize, chunkOverlap);
            return {
                filename: filename,
                title: filename.replace('.txt', ''),
                pages: 1, 
                chunks: chunks,
                size: content.length,
            };
        }

        function chunkText(text, chunkSize, overlap) {
            const chunks = [];
            let start = 0;
            while (start < text.length) {
                const end = start + chunkSize;
                chunks.push(text.slice(start, end));
                start += chunkSize - overlap;
            }
            return chunks.filter(c => c.trim().length > 10);
        }
        
        async function createEmbedding(text) {
            const model = document.getElementById('embeddingModel').value;
            const key = dom.apiKey.value.trim();
            
            const response = await fetch('https://api.openai.com/v1/embeddings', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${key}`,
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    input: text.slice(0, 8191), 
                    model: model
                }),
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(`OpenAI API Error: ${error.error.message}`);
            }
            
            const data = await response.json();
            return data.data[0].embedding;
        }

        function showProgress(percent, text, details) {
            dom.progressFill.style.width = `${percent}%`;
            dom.progressText.textContent = text;
            dom.progressDetails.textContent = details;
        }

        function displayResults(docs) {
            dom.resultsCard.style.display = 'block';
            dom.stats.style.display = 'grid';
            
            document.getElementById('statFiles').textContent = docs.length;
            document.getElementById('statPages').textContent = docs.reduce((sum, doc) => sum + doc.pages, 0);
            document.getElementById('statChunks').textContent = processedVectors.length;
            const totalSize = docs.reduce((sum, doc) => sum + doc.size, 0);
            document.getElementById('statSize').textContent = `${(totalSize / 1024 / 1024).toFixed(2)} MB`;
            
            dom.outputSection.style.display = 'block';
            const previewJSON = JSON.stringify(window.vectorsOutput, null, 2);
            dom.outputPreview.innerHTML = highlightJSON(previewJSON);
        }
        
        function resetResults() {
            dom.resultsCard.style.display = 'none';
            processedVectors = [];
            window.vectorsOutput = null;
        }

        function downloadJSON() {
            if (!window.vectorsOutput) {
                showMessage('No vector data to download.', 'error');
                return;
            }
            const filename = document.getElementById('outputFilename').value || 'rag-vectors.json';
            const blob = new Blob([JSON.stringify(window.vectorsOutput, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
            showMessage(`Downloaded ${filename}`, 'info');
        }

        function copyOutput() {
            if (!window.vectorsOutput) {
                showMessage('Nothing to copy.', 'error');
                return;
            }
            navigator.clipboard.writeText(JSON.stringify(window.vectorsOutput, null, 2))
                .then(() => showMessage('Copied to clipboard!', 'success'))
                .catch(() => showMessage('Failed to copy.', 'error'));
        }
        
        function clearAll() {
            selectedFiles = [];
            renderFileList();
            resetResults();
            dom.fileInput.value = '';
            dom.progress.style.display = 'none';
            validateInputs();
            showMessage('All cleared!', 'info');
        }

        function showMessage(message, type) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.textContent = message;
            
            dom.messageContainer.innerHTML = '';
            dom.messageContainer.appendChild(messageDiv);
            
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.remove();
                }
            }, 4000);
        }
        
        function highlightJSON(jsonString) {
            if (!jsonString) return '';
            jsonString = jsonString.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            return jsonString.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
                let cls = 'json-number';
                if (/^"/.test(match)) {
                    if (/:$/.test(match)) {
                        cls = 'json-key';
                    } else {
                        cls = 'json-string';
                    }
                } else if (/true|false/.test(match)) {
                    cls = 'json-boolean';
                } else if (/null/.test(match)) {
                    cls = 'json-null';
                }
                return '<span class="' + cls + '">' + match + '</span>';
            });
        }
        
        const sampleDocs = {
             manual: `User Manual - Getting Started...`,
             faq: `Frequently Asked Questions...`,
             policy: `Company Policies and Procedures...`
        };
        Object.assign(sampleDocs, {
             manual: `User Manual - Getting Started

Chapter 1: Introduction
Welcome to our comprehensive user guide. This manual will help you understand all the features and capabilities of our system.

Chapter 2: Installation
To install the software, follow these steps:
1. Download the installer from our website
2. Run the installer with administrator privileges
3. Follow the installation wizard
4. Restart your computer when prompted

Chapter 3: Basic Operations
The main interface consists of three panels:
- Navigation panel on the left
- Content area in the center  
- Properties panel on the right`,
            
            faq: `Frequently Asked Questions

Q: How do I reset my password?
A: Click on "Forgot Password" on the login page, enter your email address, and follow the instructions in the email you receive.

Q: What browsers are supported?
A: We support Chrome 90+, Firefox 88+, Safari 14+, and Edge 90+. Internet Explorer is not supported.

Q: Can I use this on mobile devices?
A: Yes, our responsive design works on tablets and smartphones. We also have dedicated iOS and Android apps.

Q: How do I contact support?
A: You can reach us through:
- Email: support@company.com
- Live chat during business hours`,
            
            policy: `Company Policies and Procedures

1. Code of Conduct
All employees must maintain professional behavior and treat colleagues with respect. Discrimination, harassment, and unprofessional conduct will not be tolerated.

2. Remote Work Policy
Employees may work remotely up to 3 days per week with manager approval. Remote workers must maintain reliable internet connection and be available during core hours.

3. Data Security
All employees must use strong passwords, enable 2FA, and report security incidents immediately.

4. Time Off Policy
Full-time employees accrue vacation time at 1.5 days per month. All time off must be approved by your manager.`
        });
        
        function loadSampleDoc(type) {
            const content = sampleDocs[type];
            if (!content) return;

            const filename = `sample-${type}.txt`;
            selectedFiles = selectedFiles.filter(f => f.file.name !== filename);
            
            selectedFiles.push({
                id: `file-${Date.now()}-${type}`,
                file: { name: filename, size: content.length },
                content: content,
                type: 'sample'
            });
            
            renderFileList();
            validateInputs();
            showMessage(`Loaded ${type} sample document!`, 'info');
        }
    </script>
</body>
</html>